<div class="styled-form">
  <div class="title">Registro de Bono Corporativo</div>

  <form [formGroup]="form">
    <div class="form-grid">
      <div class="form-column">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre del bono</mat-label>
          <input matInput formControlName="nombre" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Monto nominal</mat-label>
          <input matInput type="number" formControlName="montonominal" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Moneda</mat-label>
          <mat-select formControlName="moneda">
            <mat-option *ngFor="let m of monedas" [value]="m">{{ m }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tasa de interés (%)</mat-label>
          <input matInput type="number" formControlName="tasainteres" />
        </mat-form-field>
      </div>

      <div class="form-column">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Frecuencia de pago</mat-label>
          <mat-select formControlName="frecuenciapago">
            <mat-option *ngFor="let f of frecuencias" [value]="f">{{ f }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Plazo en meses</mat-label>
          <input matInput type="number" formControlName="plazomeses" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Período de gracia</mat-label>
          <mat-select formControlName="pgracia">
            <mat-option *ngFor="let g of gracias" [value]="g">{{ g }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Fecha de emisión</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="fechaemision" />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="form-buttons">
        <button mat-stroked-button color="primary" type="button" (click)="calcular()">CALCULAR</button>
        <button mat-stroked-button color="accent" type="button" (click)="guardar()" [disabled]="form.invalid || !resultado">GUARDAR</button>
      </div>
    </div>
  </form>

  <div *ngIf="!resultado && flujos.length === 0" class="mt-4" style="color: #777;">
    Por favor, complete el formulario y presione <strong>CALCULAR</strong> para ver el flujo de caja y métricas.
  </div>

  <div *ngIf="resultado" class="result-box mt-8">
    <h3>Resultado financiero</h3>
    <p><strong>TCEA:</strong> {{ resultado.tcea * 100 | number:'1.2-2' }}%</p>
    <p><strong>TREA:</strong> {{ resultado.trea * 100 | number:'1.2-2' }}%</p>
    <p><strong>Duración:</strong> {{ resultado.duracion | number:'1.2-2' }}</p>
    <p><strong>Duración Modificada:</strong> {{ resultado.duracion_modificada | number:'1.2-2' }}</p>
    <p><strong>Convexidad:</strong> {{ resultado.convexidad | number:'1.2-2' }}</p>
    <p><strong>Precio Máximo:</strong> {{ resultado.precio_maximo | currency:form.value.moneda }}</p>
  </div>

  <mat-table *ngIf="flujos.length > 0" [dataSource]="flujos" class="mat-elevation-z8 mt-6">
    <ng-container matColumnDef="periodo">
      <th mat-header-cell *matHeaderCellDef>Periodo</th>
      <td mat-cell *matCellDef="let f">{{ f.periodo }}</td>
    </ng-container>

    <ng-container matColumnDef="fecha_pago">
      <th mat-header-cell *matHeaderCellDef>Fecha de pago</th>
      <td mat-cell *matCellDef="let f">{{ f.fecha_pago | date }}</td>
    </ng-container>

    <ng-container matColumnDef="interes">
      <th mat-header-cell *matHeaderCellDef>Interés</th>
      <td mat-cell *matCellDef="let f">{{ f.interes | number:'1.2-2' }}</td>
    </ng-container>

    <ng-container matColumnDef="amortizacion">
      <th mat-header-cell *matHeaderCellDef>Amortización</th>
      <td mat-cell *matCellDef="let f">{{ f.amortizacion | number:'1.2-2' }}</td>
    </ng-container>

    <ng-container matColumnDef="cuotatotal">
      <th mat-header-cell *matHeaderCellDef>Cuota total</th>
      <td mat-cell *matCellDef="let f">{{ f.cuotatotal | number:'1.2-2' }}</td>
    </ng-container>

    <ng-container matColumnDef="saldo">
      <th mat-header-cell *matHeaderCellDef>Saldo</th>
      <td mat-cell *matCellDef="let f">{{ f.saldo | number:'1.2-2' }}</td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </mat-table>
</div>
